---
title: 检测对 EWS 和 REST 在 Exchange 中的客户端请求
manager: sethgros
ms.date: 4/13/2016
ms.audience: Developer
localization_priority: Normal
ms.assetid: 330de503-498d-447e-b4a9-c20fc1699fd1
description: 了解 EWS 和 REST 请求中的 HTTP 标头，以及可帮助您监视 Exchange 应用程序并对其进行故障排除的响应。
ms.openlocfilehash: 3a8ce889ec7a6b9e70ec25a95ac248902f48ca6c
ms.sourcegitcommit: 88ec988f2bb67c1866d06b361615f3674a24e795
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/03/2020
ms.locfileid: "44456302"
---
# <a name="instrumenting-client-requests-for-ews-and-rest-in-exchange"></a><span data-ttu-id="905fd-103">检测对 EWS 和 REST 在 Exchange 中的客户端请求</span><span class="sxs-lookup"><span data-stu-id="905fd-103">Instrumenting client requests for EWS and REST in Exchange</span></span>

<span data-ttu-id="905fd-104">了解 EWS 和 REST 请求中的 HTTP 标头，以及可帮助您监视 Exchange 应用程序并对其进行故障排除的响应。</span><span class="sxs-lookup"><span data-stu-id="905fd-104">Learn about the HTTP headers in EWS and REST requests and responses that can help you monitor and troubleshoot your Exchange application.</span></span>
  
<span data-ttu-id="905fd-105">是否曾对你发生这种情况？</span><span class="sxs-lookup"><span data-stu-id="905fd-105">Has this ever happened to you?</span></span> <span data-ttu-id="905fd-106">您的应用程序的用户报告了意外错误。</span><span class="sxs-lookup"><span data-stu-id="905fd-106">A user of your application reports an unexpected error.</span></span> <span data-ttu-id="905fd-107">您想要调查，但不能再现。</span><span class="sxs-lookup"><span data-stu-id="905fd-107">You want to investigate, but you can't reproduce it.</span></span> <span data-ttu-id="905fd-108">用户的错误已消失，并且你已离开非常少可操作的数据。</span><span class="sxs-lookup"><span data-stu-id="905fd-108">The error has disappeared for the user, and you're left with very little actionable data.</span></span> <span data-ttu-id="905fd-109">令人沮丧，不是吗？</span><span class="sxs-lookup"><span data-stu-id="905fd-109">Frustrating, isn't it?</span></span> <span data-ttu-id="905fd-110">让我们来看看如何主动准备此方案，并避免将来出现挫折。</span><span class="sxs-lookup"><span data-stu-id="905fd-110">Let's look at how you can proactively prepare for this scenario and hopefully avoid frustration in the future.</span></span>
  
## <a name="add-instrumentation-to-requests"></a><span data-ttu-id="905fd-111">向请求添加检测</span><span class="sxs-lookup"><span data-stu-id="905fd-111">Add instrumentation to requests</span></span>

<span data-ttu-id="905fd-112">建议您向请求添加其他 HTTP 标头，以便于进行故障排除。</span><span class="sxs-lookup"><span data-stu-id="905fd-112">We recommend that you add additional HTTP headers to your requests to facilitate troubleshooting.</span></span> <span data-ttu-id="905fd-113">应将此信息记录保留在某个位置（例如，在日志文件中），以便稍后在需要时检索此信息。</span><span class="sxs-lookup"><span data-stu-id="905fd-113">You should keep a record of this information somewhere (for example, in a log file) so that you can retrieve it later if you need to.</span></span> <span data-ttu-id="905fd-114">这在检查网络流量时很有帮助，如果你联系 Microsoft 支持部门寻求帮助，也很有用。</span><span class="sxs-lookup"><span data-stu-id="905fd-114">This is helpful when examining network traffic, and is also helpful if you contact Microsoft support for assistance.</span></span>
  
<span data-ttu-id="905fd-115">**表1。用于故障排除的请求标头**</span><span class="sxs-lookup"><span data-stu-id="905fd-115">**Table 1. Request headers for troubleshooting**</span></span>

|<span data-ttu-id="905fd-116">**HTTP 标头（EWS）**</span><span class="sxs-lookup"><span data-stu-id="905fd-116">**HTTP header (EWS)**</span></span>|<span data-ttu-id="905fd-117">**EWS 托管 API 等效项**</span><span class="sxs-lookup"><span data-stu-id="905fd-117">**EWS Managed API equivalent**</span></span>|<span data-ttu-id="905fd-118">**备注**</span><span class="sxs-lookup"><span data-stu-id="905fd-118">**Notes**</span></span>|
|:-----|:-----|:-----|
|<span data-ttu-id="905fd-119">用户代理</span><span class="sxs-lookup"><span data-stu-id="905fd-119">User-Agent</span></span>  <br/> |[<span data-ttu-id="905fd-120">ExchangeService。 UserAgent</span><span class="sxs-lookup"><span data-stu-id="905fd-120">ExchangeService.UserAgent</span></span>](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.useragent%28v=exchg.80%29.aspx) <br/> |<span data-ttu-id="905fd-121">将此值设置为标识客户端应用程序的唯一值。</span><span class="sxs-lookup"><span data-stu-id="905fd-121">Set this to a unique value that identifies your client application.</span></span><br/><br/> <span data-ttu-id="905fd-122">如果你的应用程序发送的所有请求使用相同的值，Microsoft 可以在出现呼叫故障时帮助解决呼叫故障。</span><span class="sxs-lookup"><span data-stu-id="905fd-122">Using the same value for all requests that your application sends allows Microsoft to help troubleshoot call failures, should they arise.</span></span>  <br/> |
|<span data-ttu-id="905fd-123">客户端请求 id</span><span class="sxs-lookup"><span data-stu-id="905fd-123">client-request-id</span></span>  <br/> |[<span data-ttu-id="905fd-124">ExchangeService。 ClientRequestId</span><span class="sxs-lookup"><span data-stu-id="905fd-124">ExchangeService.ClientRequestId</span></span>](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.clientrequestid%28v=exchg.80%29.aspx) <br/> |<span data-ttu-id="905fd-125">对于您的应用程序发送的每个请求，请将此值设置为不同的唯一值。</span><span class="sxs-lookup"><span data-stu-id="905fd-125">Set this to a different unique value for every request your application sends.</span></span><br/><br/> <span data-ttu-id="905fd-126">建议使用 GUID。</span><span class="sxs-lookup"><span data-stu-id="905fd-126">We recommend that you use a GUID.</span></span> <span data-ttu-id="905fd-127">此唯一标识符用于在两个系统之间关联活动，以便在发生错误时进行关联。</span><span class="sxs-lookup"><span data-stu-id="905fd-127">This unique identifier is intended to be used to correlate activities between two systems in the event that something goes wrong.</span></span>  <br/> |
|<span data-ttu-id="905fd-128">返回-客户端请求 id</span><span class="sxs-lookup"><span data-stu-id="905fd-128">return-client-request-id</span></span>  <br/> |[<span data-ttu-id="905fd-129">ExchangeService。 ReturnClientRequestId</span><span class="sxs-lookup"><span data-stu-id="905fd-129">ExchangeService.ReturnClientRequestId</span></span>](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.returnclientrequestid%28v=exchg.80%29.aspx) <br/> |<span data-ttu-id="905fd-130">将此值设置为**true** ，以向 Exchange 服务器发出信号，告知 Exchange 服务器它应在相应的响应中返回客户端请求 id 的值。</span><span class="sxs-lookup"><span data-stu-id="905fd-130">Set this to **true** to signal to the Exchange server that it should return the value of your client-request-id in the corresponding response.</span></span><br/><br/> <span data-ttu-id="905fd-131">您可以使用此项在网络跟踪或 EWS 托管 API 跟踪中关联请求和响应。</span><span class="sxs-lookup"><span data-stu-id="905fd-131">You can use this to correlate requests and responses in network traces or EWS Managed API traces.</span></span>  <br/> |
|<span data-ttu-id="905fd-132">X-ClientStatistics</span><span class="sxs-lookup"><span data-stu-id="905fd-132">X-ClientStatistics</span></span>  <br/> |[<span data-ttu-id="905fd-133">ExchangeService。 SendClientLatencies</span><span class="sxs-lookup"><span data-stu-id="905fd-133">ExchangeService.SendClientLatencies</span></span>](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.sendclientlatencies%28v=exchg.80%29.aspx) <br/> |<span data-ttu-id="905fd-134">用于向 Microsoft[报告 EWS 延迟](#bk_ReportLatency)（如果应用程序作为 Office 365 的一部分访问 exchange Online 或 exchange online）。</span><span class="sxs-lookup"><span data-stu-id="905fd-134">Used to [report EWS latencies](#bk_ReportLatency) to Microsoft if your application is accessing Exchange Online or Exchange Online as part of Office 365.</span></span>  <br/> |
   
## <a name="log-information-from-responses"></a><span data-ttu-id="905fd-135">记录响应中的信息</span><span class="sxs-lookup"><span data-stu-id="905fd-135">Log information from responses</span></span>

<span data-ttu-id="905fd-136">正如您的客户端可以向其发送的请求中添加额外的规范一样，Exchange 会将其他检测添加到 HTTP 头形式的响应中。</span><span class="sxs-lookup"><span data-stu-id="905fd-136">Just as your client can add additional instrumentation to the requests it sends, Exchange adds additional instrumentation to the responses in the form of HTTP headers.</span></span> <span data-ttu-id="905fd-137">您的客户端应捕获此信息以与请求检测信息一起使用。</span><span class="sxs-lookup"><span data-stu-id="905fd-137">Your client should capture this information to go along with the request instrumentation information.</span></span>
  
> [!NOTE]
> <span data-ttu-id="905fd-138">如果使用 EWS 托管 API，则 HTTP 头没有直接等效项。</span><span class="sxs-lookup"><span data-stu-id="905fd-138">If you are using the EWS Managed API, there is no direct equivalent for the HTTP headers.</span></span> <span data-ttu-id="905fd-139">但是，可以通过[ExchangeService](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.httpresponseheaders%28v=exchg.80%29.aspx)属性访问所有 HTTP 响应头。</span><span class="sxs-lookup"><span data-stu-id="905fd-139">However, all HTTP response headers can be accessed via the [ExchangeService.HttpResponseHeaders](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.httpresponseheaders%28v=exchg.80%29.aspx) property.</span></span> 
  
<span data-ttu-id="905fd-140">**表2。HTTP 响应头**</span><span class="sxs-lookup"><span data-stu-id="905fd-140">**Table 2. HTTP response headers**</span></span>

|<span data-ttu-id="905fd-141">**HTTP 标头**</span><span class="sxs-lookup"><span data-stu-id="905fd-141">**HTTP header**</span></span>|<span data-ttu-id="905fd-142">**说明**</span><span class="sxs-lookup"><span data-stu-id="905fd-142">**Description**</span></span>|
|:-----|:-----|
|<span data-ttu-id="905fd-143">请求 id</span><span class="sxs-lookup"><span data-stu-id="905fd-143">request-id</span></span>  <br/> |<span data-ttu-id="905fd-144">与此响应对应的请求的服务器生成 ID。</span><span class="sxs-lookup"><span data-stu-id="905fd-144">A server-generated ID for the request that corresponds to this response.</span></span>  <br/> |
|<span data-ttu-id="905fd-145">客户端请求 id</span><span class="sxs-lookup"><span data-stu-id="905fd-145">client-request-id</span></span>  <br/> |<span data-ttu-id="905fd-146">请求中的客户端请求 id 标头的值。</span><span class="sxs-lookup"><span data-stu-id="905fd-146">The value of the client-request-id header in the request.</span></span><br/><br/> <span data-ttu-id="905fd-147">仅当请求包含的返回客户端请求 id 标头的值**为 true**时，才会出现此标头。</span><span class="sxs-lookup"><span data-stu-id="905fd-147">This header is only present if the request contains the return-client-request-id header with a value of **true**.</span></span>  <br/> |
|<span data-ttu-id="905fd-148">X-FEServer</span><span class="sxs-lookup"><span data-stu-id="905fd-148">X-FEServer</span></span>  <br/> |<span data-ttu-id="905fd-149">处理请求的客户端访问服务器的 FQDN。</span><span class="sxs-lookup"><span data-stu-id="905fd-149">The FQDN of the Client Access server that processed the request.</span></span>  <br/> |
|<span data-ttu-id="905fd-150">X-TargetBEServer</span><span class="sxs-lookup"><span data-stu-id="905fd-150">X-TargetBEServer</span></span>  <br/> |<span data-ttu-id="905fd-151">处理请求的邮箱服务器的 FQDN。</span><span class="sxs-lookup"><span data-stu-id="905fd-151">The FQDN of the mailbox server that processed the request.</span></span>  <br/> |
|<span data-ttu-id="905fd-152">X-X-diaginfo</span><span class="sxs-lookup"><span data-stu-id="905fd-152">X-DiagInfo</span></span>  <br/> |<span data-ttu-id="905fd-153">其他诊断信息，具体取决于请求。</span><span class="sxs-lookup"><span data-stu-id="905fd-153">Additional diagnostic information, depending on the request.</span></span>  <br/> |
|<span data-ttu-id="905fd-154">x-ms-诊断</span><span class="sxs-lookup"><span data-stu-id="905fd-154">x-ms-diagnostics</span></span>  <br/> | <span data-ttu-id="905fd-155">只有在请求中使用 OAuth 身份验证时，此标头才适用。</span><span class="sxs-lookup"><span data-stu-id="905fd-155">This header is only applicable if OAuth authentication is used in the request.</span></span><br/><br/> <span data-ttu-id="905fd-156">它包含显式错误代码，用于指定 OAuth 身份验证失败的原因。</span><span class="sxs-lookup"><span data-stu-id="905fd-156">It contains an explicit error code that specifies why an OAuth authentication failed.</span></span><br/><br/> <span data-ttu-id="905fd-157">它采用以下格式：`errorId;reason="reason"error_type="error type"`</span><span class="sxs-lookup"><span data-stu-id="905fd-157">It takes the following format: `errorId;reason="reason"error_type="error type"`</span></span><br/><br/> <span data-ttu-id="905fd-158">**原因**字段是可读的错误的说明。</span><span class="sxs-lookup"><span data-stu-id="905fd-158">The **reason** field is a human-readable description of the error.</span></span><br/><br/> <span data-ttu-id="905fd-159">**ErrorId**字段是一个整数，**错误 \_ 类型**字段是该整数的字符串表示形式，如下所示：</span><span class="sxs-lookup"><span data-stu-id="905fd-159">The **errorId** field is an integer, and the **error\_type** field is the string representation of that integer, as follows:</span></span><ul><li><span data-ttu-id="905fd-160">2000000： \_ 签名无效</span><span class="sxs-lookup"><span data-stu-id="905fd-160">2000000: invalid\_signature</span></span></li><li><span data-ttu-id="905fd-161">2000001： \_ 令牌无效</span><span class="sxs-lookup"><span data-stu-id="905fd-161">2000001: invalid\_token</span></span></li><li>  <span data-ttu-id="905fd-162">2000002：令牌已 \_ 过期</span><span class="sxs-lookup"><span data-stu-id="905fd-162">2000002: token\_expired</span></span></li><li><span data-ttu-id="905fd-163">2000003： \_ 资源无效</span><span class="sxs-lookup"><span data-stu-id="905fd-163">2000003: invalid\_resource</span></span></li><li><span data-ttu-id="905fd-164">2000004： \_ 租户无效</span><span class="sxs-lookup"><span data-stu-id="905fd-164">2000004: invalid\_tenant</span></span>  </li><li><span data-ttu-id="905fd-165">2000005： \_ 用户无效</span><span class="sxs-lookup"><span data-stu-id="905fd-165">2000005: invalid\_user</span></span></li><li><span data-ttu-id="905fd-166">2000006： \_ 客户端无效</span><span class="sxs-lookup"><span data-stu-id="905fd-166">2000006: invalid\_client</span></span></li><li><span data-ttu-id="905fd-167">2000007：内部 \_ 错误</span><span class="sxs-lookup"><span data-stu-id="905fd-167">2000007: internal\_error</span></span></li><li><span data-ttu-id="905fd-168">2000008： \_ 授予无效</span><span class="sxs-lookup"><span data-stu-id="905fd-168">2000008: invalid\_grant</span></span></li></ul> |
   
## <a name="report-ews-latency-to-microsoft"></a><span data-ttu-id="905fd-169">向 Microsoft 报告 EWS 延迟</span><span class="sxs-lookup"><span data-stu-id="905fd-169">Report EWS latency to Microsoft</span></span>
<span data-ttu-id="905fd-170"><a name="bk_ReportLatency"> </a></span><span class="sxs-lookup"><span data-stu-id="905fd-170"><a name="bk_ReportLatency"> </a></span></span>

<span data-ttu-id="905fd-171">如果应用程序使用 EWS 托管 API 或 EWS 连接到 Exchange Online，则可以将 EWS 请求中的延迟直接报告给 Microsoft。</span><span class="sxs-lookup"><span data-stu-id="905fd-171">If your application uses the EWS Managed API or EWS to connect to Exchange Online, you can report latency in EWS requests directly to Microsoft.</span></span> <span data-ttu-id="905fd-172">通过 ClientStatistics 请求标头传递信息。</span><span class="sxs-lookup"><span data-stu-id="905fd-172">The information is passed via the X-ClientStatistics request header.</span></span> <span data-ttu-id="905fd-173">如果您使用 EWS 托管 API，您只需将[ExchangeService](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.sendclientlatencies%28v=exchg.80%29.aspx)属性设置为**true**。</span><span class="sxs-lookup"><span data-stu-id="905fd-173">If you are using the EWS Managed API, all you have to do is set the [ExchangeService.SendClientLatencies](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.sendclientlatencies%28v=exchg.80%29.aspx) property to **true**.</span></span> <span data-ttu-id="905fd-174">如果使用 EWS，则需要测量发出请求和接收响应之间的时间，然后使用以下格式将 ClientStatistics 头添加到应用程序发送的下一个 EWS 请求。</span><span class="sxs-lookup"><span data-stu-id="905fd-174">If you are using EWS, you'll need to measure the time between issuing a request and receiving a response, then add the X-ClientStatistics header to the next EWS request your application sends, using the following format.</span></span>
  
`X-ClientStatistics: MessageId=<value of request-id header>,ResponseTime=<time in milliseconds>,SoapAction=<EWS operation>`
  
<span data-ttu-id="905fd-175">我们维护这些延迟的报告，并使用它们在 Exchange Online 中持续改进 EWS 服务。</span><span class="sxs-lookup"><span data-stu-id="905fd-175">We maintain reports for these latencies and use them to continuously improve EWS services in Exchange Online.</span></span>
  
## <a name="next-steps"></a><span data-ttu-id="905fd-176">后续步骤</span><span class="sxs-lookup"><span data-stu-id="905fd-176">Next steps</span></span>
<span data-ttu-id="905fd-177"><a name="bk_ReportLatency"> </a></span><span class="sxs-lookup"><span data-stu-id="905fd-177"><a name="bk_ReportLatency"> </a></span></span>

<span data-ttu-id="905fd-178">向应用程序添加了客户端规范后，如果出现问题，则会更好地进行准备。</span><span class="sxs-lookup"><span data-stu-id="905fd-178">After you've added client instrumentation to your application, you're better prepared if something goes wrong.</span></span> <span data-ttu-id="905fd-179">如果发生这种情况，您可以使用检测数据对[应用程序进行故障排除](tools-and-resources-for-troubleshooting-ews-applications-for-exchange.md)。</span><span class="sxs-lookup"><span data-stu-id="905fd-179">If that happens, you can use your instrumentation data to [troubleshoot your application](tools-and-resources-for-troubleshooting-ews-applications-for-exchange.md).</span></span>
  
## <a name="see-also"></a><span data-ttu-id="905fd-180">另请参阅</span><span class="sxs-lookup"><span data-stu-id="905fd-180">See also</span></span>

- [<span data-ttu-id="905fd-181">Exchange 的 EWS 客户端设计概述</span><span class="sxs-lookup"><span data-stu-id="905fd-181">EWS client design overview for Exchange</span></span>](ews-client-design-overview-for-exchange.md)
- [<span data-ttu-id="905fd-182">跟踪请求和响应以便解决 EWS 托管 API 应用程序的故障</span><span class="sxs-lookup"><span data-stu-id="905fd-182">Trace requests and responses to troubleshoot EWS Managed API applications</span></span>](how-to-trace-requests-responses-to-troubleshoot-ews-managed-api-applications.md)
- [<span data-ttu-id="905fd-183">工具和资源来解决 exchange 的 EWS 应用程序</span><span class="sxs-lookup"><span data-stu-id="905fd-183">Tools and resources for troubleshooting EWS applications for Exchange</span></span>](tools-and-resources-for-troubleshooting-ews-applications-for-exchange.md)
    

