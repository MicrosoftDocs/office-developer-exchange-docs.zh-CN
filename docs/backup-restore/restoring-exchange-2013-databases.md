---
title: 还原 Exchange 2013 数据库
manager: sethgros
ms.date: 09/17/2015
ms.audience: Developer
ms.topic: overview
ms.prod: office-online-server
localization_priority: Normal
ms.assetid: e0804bb1-fd66-448a-b2cb-9ae2726ae888
description: 查找有关您可以还原 Exchange 2013 数据库以不同方式的信息。
ms.openlocfilehash: d3ca3a884b0ad30f7d7968a9ed435b02aaf205e1
ms.sourcegitcommit: 34041125dc8c5f993b21cebfc4f8b72f0fd2cb6f
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/25/2018
ms.locfileid: "19752717"
---
# <a name="restoring-exchange-2013-databases"></a><span data-ttu-id="9b4e5-103">还原 Exchange 2013 数据库</span><span class="sxs-lookup"><span data-stu-id="9b4e5-103">Restoring Exchange 2013 databases</span></span>

<span data-ttu-id="9b4e5-104">查找有关您可以还原 Exchange 2013 数据库以不同方式的信息。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-104">Find information about the different ways that you can restore your Exchange 2013 databases.</span></span> 
  
<span data-ttu-id="9b4e5-105">**适用于：** Exchange Server 2013</span><span class="sxs-lookup"><span data-stu-id="9b4e5-105">**Applies to:** Exchange Server 2013</span></span> 
  
<span data-ttu-id="9b4e5-106">是包含在 Exchange Server 2013 中如何还原 Exchange 数据库的一些灵活性允许 Exchange 编写器。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-106">The Exchange writer that is included in Exchange Server 2013 allows for some flexibility in how you restore your Exchange databases.</span></span> <span data-ttu-id="9b4e5-107">在 Exchange 2013 中使用 Exchange 编写器，您可以将卷影副本备份还原到以下位置：</span><span class="sxs-lookup"><span data-stu-id="9b4e5-107">By using the Exchange writer in Exchange 2013, you can restore your shadow copy backups to the following locations:</span></span>
  
- <span data-ttu-id="9b4e5-108">原始数据库，而不管是否已修改的数据库或事务日志文件路径配置。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-108">The original database, regardless of whether the database or transaction log file path configuration has been modified.</span></span>
    
- <span data-ttu-id="9b4e5-109">恢复数据库。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-109">A recovery database.</span></span>
    
- <span data-ttu-id="9b4e5-110">任何生产数据库，而不管是否数据库显示名称匹配中的 VSS 备份集的名称。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-110">Any production database, regardless of whether the database display name matches the name in a VSS backup set.</span></span>
    
<span data-ttu-id="9b4e5-111">当您还原应用程序还原到原始数据库的信息时，日志文件必须将还原到 Active Directory 域服务 (AD DS) 中指定的目录路径该数据库。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-111">When your restore application restores information to the original database, the log files must be restored to the directory path specified in Active Directory Domain Services (AD DS) for that database.</span></span> <span data-ttu-id="9b4e5-112">如果您的应用程序将数据库还原到不同的位置，必须将日志文件还原到名为 **_restoredLogs**内数据库日志文件目录位于的文件夹中。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-112">If your application restores a database to a different location, the log files must be restored to a folder named **_restoredLogs** that is located inside the database log file directory.</span></span> 
  
<span data-ttu-id="9b4e5-113">当还原到服务器或不同于原始数据库的数据库，您还原应用程序必须确保提供给 VSS 的数据库目录路径与匹配那些 AD DS 中。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-113">When restoring to a server or database that is different than the original database, your restore application must make sure that the database directory paths provided to VSS match those in AD DS.</span></span> <span data-ttu-id="9b4e5-114">可以使用[Get-mailboxdatabase](http://technet.microsoft.com/zh-cn/library/bb124924%28v=exchg.150%29.aspx)Exchange Management Shell cmdlet 以获取有关现有数据库的信息。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-114">You can use the [get-MailboxDatabase](http://technet.microsoft.com/zh-cn/library/bb124924%28v=exchg.150%29.aspx)Exchange Management Shell cmdlet to get information about existing databases.</span></span> <span data-ttu-id="9b4e5-115">有关 Exchange 命令行管理程序的详细信息，请参阅[Exchange Server PowerShell (Exchange Management Shell)](https://docs.microsoft.com/zh-cn/powershell/exchange/exchange-server/exchange-management-shell?view=exchange-ps)。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-115">For more information about the Exchange Management Shell, see [Exchange Server PowerShell (Exchange Management Shell)](https://docs.microsoft.com/zh-cn/powershell/exchange/exchange-server/exchange-management-shell?view=exchange-ps).</span></span> 
  
<span data-ttu-id="9b4e5-116">下图显示典型 Exchange 数据库管理的卷影复制服务 (VSS) 还原中的事件顺序。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-116">The following figure shows the sequence of events in a typical restore of an Exchange database that is managed by the Volume Shadow Copy Service (VSS).</span></span>
  
<span data-ttu-id="9b4e5-117">**图 1。还原数据库的事件顺序**</span><span class="sxs-lookup"><span data-stu-id="9b4e5-117">**Figure 1. Sequence of events for restoring databases**</span></span>

![此图显示恢复过程的事件序列。该序列从 Exchange 存储启动开始，然后是继续经历 Exchange 编写器、VSS 和客户端应用程序之间的多个步骤。](media/VSS_StoreWriterRestore.gif)
  
## <a name="restoring-exchange-databases-to-the-original-location"></a><span data-ttu-id="9b4e5-120">Exchange 数据库还原到原始位置</span><span class="sxs-lookup"><span data-stu-id="9b4e5-120">Restoring Exchange databases to the original location</span></span>
<span data-ttu-id="9b4e5-121"><a name="bk_OriginalLocation"> </a></span><span class="sxs-lookup"><span data-stu-id="9b4e5-121"></span></span>

<span data-ttu-id="9b4e5-122">Exchange 书写器使应用程序还原到其原始位置的 Exchange 服务器上的数据库和事务日志文件。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-122">The Exchange writer enables applications to restore databases and transaction log files to their original locations on the Exchange server.</span></span> <span data-ttu-id="9b4e5-123">默认情况下，Exchange 书写器重播事务日志文件后申请者确认[OnPostRestore](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa381566%28v=vs.85%29.aspx)操作期间已完成还原。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-123">By default, the Exchange writer replays the transaction log files after the requester confirms that the restore is complete during the [OnPostRestore](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa381566%28v=vs.85%29.aspx) operation.</span></span> <span data-ttu-id="9b4e5-124">还原应用程序必须使用 VSS [SetAdditionalRestores](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382829%28v=vs.85%29.aspx)方法以避免在重播日志文件。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-124">The restore application must use the VSS [SetAdditionalRestores](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382829%28v=vs.85%29.aspx) method to prevent having the log files replayed.</span></span> <span data-ttu-id="9b4e5-125">可以在以后当 Exchange 管理员或您的应用程序重新载入还原的数据库重播日志文件。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-125">The log files can be replayed at a later time when the Exchange administrator or your application remounts the restored database.</span></span> 
  
<span data-ttu-id="9b4e5-126">当还原回其原始数据库的数据库对象 （例如，在数据库中的目标 Guid 匹配备份集中） 但的应用程序必须确定当前的文件路径和到将备份文件还原到不同的文件路径在数据库属性中指定相应的文件路径。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-126">When restoring databases back to their original database objects (such that the target GUIDs in the database match those in the backup set) but to different file paths, the application must determine the current file paths and restore the backup files to the corresponding file paths specified in the database properties.</span></span> <span data-ttu-id="9b4e5-127">请求者必须调用[AddNewTarget](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382648%28v=vs.85%29.aspx)方法进行通信到 Exchange 编写器之前作者可以继续还原过程的其余部分，其中还原文件的位置。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-127">The requester must call the [AddNewTarget](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382648%28v=vs.85%29.aspx) method to communicate to the Exchange writer the location where the files are restored before the writer can continue with the rest of the restore process.</span></span> <span data-ttu-id="9b4e5-128">如果未调用**AddNewTarget** ，Exchange 书写器假定，将备份还原到备份元数据文档中指定的文件路径。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-128">If **AddNewTarget** is not called, the Exchange writer assumes that the backups are restored to the file paths specified in the backup metadata document.</span></span> 
  
<span data-ttu-id="9b4e5-129">通常情况下，您的应用程序不必指定从数据库可用性组 (DAG) 复制执行的备份的新路径。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-129">Typically, your application does not have to specify a new path for backups that are performed from a Database Availability Group (DAG) copy.</span></span> <span data-ttu-id="9b4e5-130">Exchange 管理员通常不会更改数据库或日志文件路径。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-130">Exchange administrators do not usually change database or log file paths.</span></span> <span data-ttu-id="9b4e5-131">在 DAG 配置中，但是，备份应用程序可能需要指定活动数据库和日志路径，因为始终这些路径不同 DAG 的复制路径。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-131">In a DAG configuration, however, the backup application might have to specify the active database and log paths, because DAG copy paths are always different from those paths.</span></span>
  
<span data-ttu-id="9b4e5-132">请注意，Exchange 2013 不支持还原非活动 DAG 数据库副本。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-132">Note that Exchange 2013 does not support restoring inactive DAG database copies.</span></span> <span data-ttu-id="9b4e5-133">仅当还原主动数据库副本时，可以从备份数据还原 DAG 副本。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-133">DAG copies can be restored from backup data only when the active database copy is restored.</span></span> <span data-ttu-id="9b4e5-134">使用不同的备份数据集或尝试还原的数据库副本的子集可能会导致要成为均不可装入的数据库。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-134">Using different backup data sets or attempting to restore a subset of the database copies can cause the database to become unmountable.</span></span> <span data-ttu-id="9b4e5-135">备份应用程序无需调用[SetRestoreOptions](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382856%28v=vs.85%29.aspx)函数在这种情况下，因为备份还原到原始数据库对象从创建它们。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-135">Backup applications do not have to call the [SetRestoreOptions](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382856%28v=vs.85%29.aspx) function in this case, because the backups are restored to the original database objects they were created from.</span></span> <span data-ttu-id="9b4e5-136">但是，如果在备份应用程序调用**SetRestoreOptions**和 XML 元数据文档具有正确的参数，结果不是错误。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-136">However, if the backup application calls **SetRestoreOptions** and the XML metadata document has the correct parameters, the result is not an error.</span></span> 
  
## <a name="restoring-exchange-databases-to-a-recovery-database"></a><span data-ttu-id="9b4e5-137">Exchange 数据库还原到恢复数据库</span><span class="sxs-lookup"><span data-stu-id="9b4e5-137">Restoring Exchange databases to a recovery database</span></span>
<span data-ttu-id="9b4e5-138"><a name="bk_RecoveryDatabase"> </a></span><span class="sxs-lookup"><span data-stu-id="9b4e5-138"></span></span>

<span data-ttu-id="9b4e5-139">Exchange 书写器，您可以直接向恢复数据库还原数据。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-139">The Exchange writer enables you to restore data directly to a recovery database.</span></span> <span data-ttu-id="9b4e5-140">为恢复数据库恢复的数据装载允许 Exchange 管理员还原单个邮箱和邮箱中的甚至是单个项目。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-140">Mounting the recovered data as a recovery database allows the Exchange administrator to restore individual mailboxes, and even individual items in a mailbox.</span></span>
  
<span data-ttu-id="9b4e5-141">如果恢复数据库已存在，您的应用程序可以卸除数据库还原到恢复的数据库和日志文件的数据，然后重新装入数据库。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-141">If a recovery database already exists, your application can dismount the database, restore the data onto the recovery database and log files, and then remount the database.</span></span>
  
<span data-ttu-id="9b4e5-142">每个 Exchange 2013 服务器允许装入一次只有一个恢复数据库。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-142">Each Exchange 2013 server allows for only one recovery database to be mounted at a time.</span></span> <span data-ttu-id="9b4e5-143">服务器可以包含多个已恢复的数据库磁盘空间允许，但可以作为恢复数据库装载只有一个。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-143">The server can contain as many recovered databases as disk space allows, but only one can be mounted as the recovery database.</span></span> <span data-ttu-id="9b4e5-144">为恢复数据库装入的数据库计数中可以一次装入的数据库的最大数目。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-144">The database mounted as the recovery database is counted in the maximum number of databases that can be mounted at a time.</span></span> <span data-ttu-id="9b4e5-145">恢复的数据库装入，服务器恢复数据库不与任何方式中的原始邮箱相关联。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-145">A recovered database mounted as a server's recovery database is not associated with the original mailbox in any way.</span></span>
  
<span data-ttu-id="9b4e5-146">若要恢复的数据库恢复，您的应用程序必须调用[SetRestoreOptions](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382856%28v=vs.85%29.aspx)方法并提供 XML 文档指示源和目标数据库的 Guid。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-146">To recover to a recovery database, your application must call the [SetRestoreOptions](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382856%28v=vs.85%29.aspx) method and provide an XML document that indicates the source and target database GUIDs.</span></span> <span data-ttu-id="9b4e5-147">源 Guid 必须匹配从备份集，并且目标 Guid 必须匹配 AD DS 中的目标数据库条目。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-147">The source GUIDs must match those from the backup set, and the target GUIDs must match the destination database entries in AD DS.</span></span> <span data-ttu-id="9b4e5-148">备份应用程序还必须调用[AddNewTarget](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382648%28v=vs.85%29.aspx)方法可指定将文件还原到其中的目录路径。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-148">The backup application must also call the [AddNewTarget](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382648%28v=vs.85%29.aspx) method to specify the directory path where the files are restored to.</span></span> <span data-ttu-id="9b4e5-149">如果需要重命名的数据库文件，因此 Exchange 书写器[OnPostRestore](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa381566%28v=vs.85%29.aspx)操作过程中将重命名数据库。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-149">If the database files need to be renamed, the Exchange writer will rename the database during the [OnPostRestore](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa381566%28v=vs.85%29.aspx) operation.</span></span> <span data-ttu-id="9b4e5-150">Exchange 需要当前的事务日志文件路径下的事务日志文件还原到的子文件夹 ( **_restoredLogs**)。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-150">Exchange requires the transaction log files to be restored to a subfolder ( **_restoredLogs**) under the current transaction log file path.</span></span> <span data-ttu-id="9b4e5-151">如果日志文件还原到其他任何位置，Exchange 作者将返回错误。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-151">If the log files are restored to any other location, the Exchange writer will return an error.</span></span> <span data-ttu-id="9b4e5-152">正在为恢复数据库装入的数据库不还原到其原始位置中，因为他们需要之前可以装载放入干净关闭状态。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-152">Because databases being mounted as the recovery database are not restored to their original location, they need to be brought into clean-shutdown state before they can be mounted.</span></span> <span data-ttu-id="9b4e5-153">默认情况下，Exchange 作者将所有还原的数据库置于干净关闭状态期间还原后。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-153">By default, the Exchange writer will bring all the restored databases into a clean-shutdown state during post-restore.</span></span> <span data-ttu-id="9b4e5-154">如果备份应用程序调用[SetAdditionalRestores](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382829%28v=vs.85%29.aspx)方法，Exchange 编写器将不会重播日志文件，并且管理员或备份应用程序需要数据库置于干净关闭状态之前安装数据库。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-154">If your backup application calls the [SetAdditionalRestores](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382829%28v=vs.85%29.aspx) method, the Exchange writer will not replay the log files, and either the administrator or your backup application needs to bring the database into a clean-shutdown state prior to mounting the database.</span></span> 
  
## <a name="restoring-exchange-databases-to-a-recovery-server"></a><span data-ttu-id="9b4e5-155">Exchange 数据库还原到恢复服务器</span><span class="sxs-lookup"><span data-stu-id="9b4e5-155">Restoring Exchange databases to a recovery server</span></span>
<span data-ttu-id="9b4e5-156"><a name="bk_RecoveryServer"> </a></span><span class="sxs-lookup"><span data-stu-id="9b4e5-156"></span></span>

<span data-ttu-id="9b4e5-157">在某些情况下，您可能需要将设置为另一台服务器; 备份恢复例如，您可能需要迁移到另一个 Exchange 2013 服务器，在同一 Exchange 组织的邮箱数据库恢复灾难性服务器故障或还原到生产环境，要恢复的邮箱外的专用服务器和公用文件夹数据。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-157">In some scenarios, you might need to recover a backup set to another server; For example, you might need to recover from a catastrophic server failure by porting the mailbox database to another Exchange 2013 server in the same Exchange organization, or restore to a dedicated server outside the production environment to recover mailbox and public folder data.</span></span> 
  
<span data-ttu-id="9b4e5-158">在这些情况下，是不同于原始数据库的目标数据库，以及其对象 Guid 的文件路径。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-158">In these scenarios, the file paths for the target database as well as its object GUIDs are different than those for the original database.</span></span> <span data-ttu-id="9b4e5-159">因此，您的应用程序必须调用具有指示的源和目标数据库信息和呼叫[AddNewTarget](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382648%28v=vs.85%29.aspx)方法可以指定的目录路径还原到备份文件的 XML 文档的[SetRestoreOptions](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382856%28v=vs.85%29.aspx)方法.</span><span class="sxs-lookup"><span data-stu-id="9b4e5-159">Therefore, your application has to call the [SetRestoreOptions](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382856%28v=vs.85%29.aspx) method with an XML document that indicates the source and target database information, and call the [AddNewTarget](http://msdn.microsoft.com/zh-cn/library/windows/desktop/aa382648%28v=vs.85%29.aspx) method to specify the directory paths to restore the backup files to.</span></span> <span data-ttu-id="9b4e5-160">Exchange writer，此还原将还原到恢复数据库相同。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-160">For the Exchange writer, this restore is the same as restoring to a recovery database.</span></span> <span data-ttu-id="9b4e5-161">有关详细信息，请参阅上文中的[恢复数据库还原 Exchange 数据库](restoring-exchange-2013-databases.md#bk_RecoveryDatabase)。</span><span class="sxs-lookup"><span data-stu-id="9b4e5-161">For more information, see [Restoring Exchange databases to a recovery database](restoring-exchange-2013-databases.md#bk_RecoveryDatabase) earlier in this article.</span></span> 
  
## <a name="see-also"></a><span data-ttu-id="9b4e5-162">另请参阅</span><span class="sxs-lookup"><span data-stu-id="9b4e5-162">See also</span></span>
<span data-ttu-id="9b4e5-163"><a name="bk_AdditionalResources"> </a></span><span class="sxs-lookup"><span data-stu-id="9b4e5-163"></span></span>

- [<span data-ttu-id="9b4e5-164">Exchange 2013 的备份操作的类型</span><span class="sxs-lookup"><span data-stu-id="9b4e5-164">Types of backup operations for Exchange 2013</span></span>](types-of-backup-operations-for-exchange-2013.md)
    
- [<span data-ttu-id="9b4e5-165">构建备份和还原 Exchange 2013 的应用程序</span><span class="sxs-lookup"><span data-stu-id="9b4e5-165">Build backup and restore applications for Exchange 2013</span></span>](build-backup-and-restore-applications-for-exchange-2013.md)
    
- [<span data-ttu-id="9b4e5-166">Exchange 2013 的备份和还原概念</span><span class="sxs-lookup"><span data-stu-id="9b4e5-166">Backup and restore concepts for Exchange 2013</span></span>](backup-and-restore-concepts-for-exchange-2013.md)
    
- [<span data-ttu-id="9b4e5-167">CChkSGFiles 类参考 （英文）</span><span class="sxs-lookup"><span data-stu-id="9b4e5-167">CChkSGFiles class reference</span></span>](cchksgfiles-class-reference.md)
    

